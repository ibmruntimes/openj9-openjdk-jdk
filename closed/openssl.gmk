# ===========================================================================
# (c) Copyright IBM Corp. 2018, 2025 All Rights Reserved
# ===========================================================================
# This code is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 2 only, as
# published by the Free Software Foundation.
#
# IBM designates this particular file as subject to the "Classpath" exception
# as provided by IBM in the LICENSE file that accompanied this code.
#
# This code is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# version 2 for more details (a copy is included in the LICENSE file that
# accompanied this code).
#
# You should have received a copy of the GNU General Public License version
# 2 along with this work; if not, see <http://www.gnu.org/licenses/>.
# ===========================================================================

# spec.gmk is generated by configure and contains definitions used in this makefile

ifeq (,$(wildcard $(SPEC)))
  $(error OpenSSL.gmk needs SPEC set to a proper spec.gmk)
endif

include $(SPEC)
include MakeBase.gmk

ifeq ($(call isTargetOs, windows), true)
  # Configure normally demands that we use an implementation of perl that produces
  # paths with backslashes; CONFIGURE_INSIST bypasses that requirement.
  # PERL must be an absolute path that will be usable by nmake (i.e. start with
  # a drive letter and a colon).
  OPENSSL_CONFIG_SETUP := export CONFIGURE_INSIST=true PERL='$(shell $(PATHTOOL) -m $(PERL))' &&

  # Configure produces a makefile intended for use with nmake.
  OPENSSL_MAKE := nmake

  # MAKEFLAGS uses unix-style options (with a dash) which won't be understood by nmake.
  OPENSSL_MAKE_SETUP := export INCLUDE='$(OPENJ9_VS_INCLUDE)' LIB='$(OPENJ9_VS_LIB)' && unset MAKEFLAGS &&

  # The makefile produced by OpenSSL 3+ during the configure step needs to be
  # patched. Patching involves adding double-quotes around the name of perl
  # script files. For example,
  #   "$(PERL)" util/mkdef.pl
  # must change to
  #   "$(PERL)" "util/mkdef.pl"
  # otherwise nmake appears not to invoke perl as intended.
  # Patching has no effect for earlier versions.
  OPENSSL_PATCH := \
	( $(CD) $(OPENSSL_DIR) \
		&& $(MV) -f makefile makefile.orig \
		&& $(SED) -e 's|\("$$(PERL)"\) \([A-Za-z0-9_/-]*\.pl\)|\1 "\2"|' < makefile.orig > makefile \
	)
else # windows
  OPENSSL_CONFIG_SETUP :=
  OPENSSL_MAKE := $(MAKE)
  OPENSSL_MAKE_SETUP :=
  OPENSSL_PATCH :=
endif # windows

# Identify the desired openssl target configuration.
export OPENSSL_LOCAL_CONFIG_DIR := $(call MixedPath,$(TOPDIR)/closed/openssl-conf)

ifeq ($(call isTargetOs, aix)+$(call isCompiler, clang), true+true)
  OPENSSL_TARGET := semeru-$(OPENJ9_PLATFORM_CODE)-clang
else ifeq ($(call isTargetOs, windows), true)
  OPENSSL_TARGET := VC-$(OPENJ9_PLATFORM_CODE)
else
  OPENSSL_TARGET := semeru-$(OPENJ9_PLATFORM_CODE)
endif

ifeq ($(call isTargetCpu, s390x), true)
  OPENSSL_CONFIG_CFLAGS := -march=z10
else
  OPENSSL_CONFIG_CFLAGS :=
endif

ifneq (,$(CCACHE))
  # If ccache is enabled and the environment contains either CC or CXX, their
  # values (as defined in this make) are propagated to the instance of make
  # which will build openssl causing it to fail. Instead, pass along CC and
  # CXX without the ccache wrapper.
  OPENSSL_MAKE += CC=$(ac_cv_prog_CC) CXX=$(ac_cv_prog_CXX)
endif # CCACHE

build_openssl :
	@$(ECHO) Compiling OpenSSL in $(OPENSSL_DIR) for $(OPENSSL_TARGET)$(if $(OPENSSL_CONFIG_CFLAGS), with additional CFLAGS $(OPENSSL_CONFIG_CFLAGS))
	( $(OPENSSL_CONFIG_SETUP) $(CD) $(OPENSSL_DIR) && $(PERL) Configure $(OPENSSL_CONFIG_CFLAGS) $(OPENSSL_TARGET) no-makedepend no-tests no-winstore shared )
	$(OPENSSL_PATCH)
	+ ( $(OPENSSL_MAKE_SETUP) $(CD) $(OPENSSL_DIR) && $(OPENSSL_MAKE) )

.PHONY : build_openssl
